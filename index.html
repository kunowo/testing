<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chess vs Bot</title>

<!-- Chessboard UI -->
<link rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

<style>
body {
    background: #1e1e1e;
    color: white;
    text-align: center;
    font-family: Arial;
}

#board {
    width: 400px;
    margin: 20px auto;
}

select, button {
    padding: 8px;
    margin: 10px;
    font-size: 16px;
}
</style>
</head>

<body>

<h1>?? Chess vs Bot</h1>

<label>Difficulty:</label>
<select id="difficulty">
    <option value="5">Easy</option>
    <option value="10">Medium</option>
    <option value="18">Hard</option>
</select>

<button onclick="resetGame()">Reset Game</button>

<div id="board"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stockfish/stockfish.js"></script>

<script>
let board = null
let game = new Chess()
let engine = STOCKFISH()
let skillLevel = 5

engine.postMessage("uci")
engine.postMessage("isready")

document.getElementById("difficulty").addEventListener("change", function() {
    skillLevel = parseInt(this.value)
})

function onDragStart(source, piece) {
    if (game.game_over()) return false
    if (piece.search(/^b/) !== -1) return false
}

function onDrop(source, target) {
    let move = game.move({
        from: source,
        to: target,
        promotion: 'q'
    })

    if (move === null) return 'snapback'

    window.setTimeout(makeBotMove, 250)
}

function makeBotMove() {
    if (game.game_over()) return

    engine.postMessage("position fen " + game.fen())
    engine.postMessage("setoption name Skill Level value " + skillLevel)
    engine.postMessage("go depth " + skillLevel)

    engine.onmessage = function(event) {
        if (event.data.startsWith("bestmove")) {
            let bestMove = event.data.split(" ")[1]
            game.move({
                from: bestMove.substring(0,2),
                to: bestMove.substring(2,4),
                promotion: 'q'
            })
            board.position(game.fen())
        }
    }
}

function onSnapEnd() {
    board.position(game.fen())
}

function resetGame() {
    game.reset()
    board.start()
}

board = Chessboard('board', {
    draggable: true,
    position: 'start',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd
})
</script>

</body>
</html>

